<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!--
  Copyright (c) 2012, 2018 IBM Corp. and others

  This program and the accompanying materials are made available under
  the terms of the Eclipse Public License 2.0 which accompanies this
  distribution and is available at https://www.eclipse.org/legal/epl-2.0/
  or the Apache License, Version 2.0 which accompanies this distribution and
  is available at https://www.apache.org/licenses/LICENSE-2.0.

  This Source Code may also be made available under the following
  Secondary Licenses when the conditions for such availability set
  forth in the Eclipse Public License, v. 2.0 are satisfied: GNU
  General Public License, version 2 with the GNU Classpath
  Exception [1] and GNU General Public License, version 2 with the
  OpenJDK Assembly Exception [2].

  [1] https://www.gnu.org/software/classpath/license.html
  [2] http://openjdk.java.net/legal/assembly-exception.html

  SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception
-->

<!DOCTYPE suite SYSTEM "cmdlinetester.dtd">

<!-- Test 180-a to Test 188-c: 53 tests -->

<suite id="Shared Classes CommandLineOptionTests Suite">

	<!-- Our test modes for this suite -->
	<variable name="mode204" value="-Xshareclasses:name=ShareClassesCMLTests"/>

	<!-- Set variables up -->
	<variable name="UTILITIES_PROGRAM" value="com.ibm.j9.sharedCacheAPI.tests.SharedUtilsTest"/>
	<variable name="UTILITIES_CP" value="-cp $JVM_TEST_ROOT$$PATHSEP$functional$PATHSEP$VM_Test$PATHSEP$VM_Test.jar"/>
	<variable name="UTILITIES_CACHE" value="-Xshareclasses:name=ShareClassesUtilities"/>	
	<variable name="JAVAC_DIR" value="$JAVA_HOME$$PATHSEP$bin"/>
	<variable name="CACHE_DIR" value="cacheDir=."/>
	
	<variable name="BOOTCLASSPATH" value="-Xbootclasspath/p:.$PATHSEP$Utils$CPDL$."/>
	<variable name="currentMode" value="$mode204$"/>
	<variable name="XXShareClassesEnableBCI" value="-XX:ShareClassesEnableBCI"/>
	
	<variable name="CP_HANOI" value="-cp $UTILSJAR$" />
 	<variable name="BOOTCP_HANOI" value="-Xbootclasspath/a:$UTILSJAR$" />
 	<variable name="PROGRAM_HANOI" value="org.openj9.test.ivj.Hanoi 2" />
 	<variable name="CLASS_HANOI" value="org/openj9/test/ivj/Hanoi" />
 	<variable name="BOOTSTRAP_CLASS" value="java/lang/Object" />
 	
 	<variable name="AGENT_NOCLASSMODIFICATION" value="-agentlib:jvmtitest=test:ecflh001,args:noModify" />
 	<variable name="AGENT_RETRANSFORM" value="-agentlib:jvmtitest=test:rtc001" />
 	
	<variable name="DUMPFILE" value="shrcmltest" />
	<variable name="SYSDUMP" value="-Xdump:system:file=$DUMPFILE$.dmp" />
	<variable name="JAVADUMP" value="-Xdump:java:file=$DUMPFILE$.txt" />
	<variable name="SNAPDUMP" value="-Xdump:snap:file=$DUMPFILE$.trc" />
	<!-- Override -Xdump option on z/OS -->
	<variable name="SYSDUMP" value="-Xdump:system:opts=IEATDUMP,dsn=%uid.J9CORE.DMP" platforms="zos.*" />
	
	<variable name="NON_WINDOWS_PLATFORMS" value="aix.*,linux.*,zos.*" />
	<variable name="WINDOWS_PLATFORMS" value="win.*" />

	<!-- 
		Following variable specifies cache directory to be used by tests for 'cacheDirPerm' sub-option.
		Since 'cacheDirPerm' sub-option is not applicable on Windows, we can use current dir as cache dir.
	--> 
	<variable name="CACHE_DIR_FOR_PERM_TEST" value="/tmp/ShareClassesCMLTestDir" platforms="$NON_WINDOWS_PLATFORMS$" />
	<variable name="CACHE_DIR_FOR_PERM_TEST" value="." platforms="$WINDOWS_PLATFORMS$" />
		
	<if testVariable="SCMODE" testValue="204" resultVariable="currentMode" resultValue="$mode204$"/>
	
	<echo value=" "/>
	<echo value="#######################################################"/>
	<echo value="Running tests in mode $SCMODE$ with command line options: $currentMode$"/>
	<echo value="#######################################################"/>
	<echo value=" "/>
		
	<!--
	Note:
	Most tests check for strings 'corrupt', 'JVM requested Java dump', and 'JVM requested Snap dump' in the output.
	These checks are present because a cache may be found to be corrupt, and the test could otherwise pass.
	
	The string 'corrupt' is checked because it can appear several messages like below.
		JVMSHRC443E Cache CRC is incorrect indicating a corrupt cache. Incorrect cache CRC: 0x0.
		JVMDUMP013I Processed dump event "corruptcache", detail "".
		JVMSHRC442E Shared cache "jim" is corrupt. Corruption code is -1. Corrupt value is 0x0. No new JVMs will be allowed to connect to the cache.
	-->
		
	<test id="Start : Cleanup: persistent" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>


	<test id="Start: Cleanup: nonpersistent" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,nonpersistent,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="failure" caseSensitive="no"  regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	<!-- 
		Note: Tests 180(a-h) validate following scenario:
		When running with -Xshareclasses:enableBCI, verify that intermediate class data is present for 
		bootstrap/non-bootstrap classes stored in cache, whether a JVMTI agent is being used or not.
	-->
	
	<!-- Remove stale dumps, if any. Test 180-a is going to create new dumps. -->
	<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
	<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
	
	<test id="Test 180-a: Create a system dump by using a shared cache with enableBCI option and with a JVMTI agent" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $SYSDUMP$,events=vmstop $currentMode$,reset,enableBCI $AGENT_NOCLASSMODIFICATION$ $CP_HANOI$ $PROGRAM_HANOI$</command>
		<output type="success" regex="no">Moved disk 0 to 1</output>
		<output type="required" regex="no" >System dump written</output>
		<!-- check for unexpected core dumps -->
		<output type="failure" regex="no">0001.dmp</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
	</test>
	
	<test id="Test 180-b: Make sure system dump exists." timeout="600" runPath=".">
		<exec command="sh" capture="LOGNAME" platforms="zos.*" >
			<arg>-c</arg>
			<arg>echo $$LOGNAME</arg>
		</exec>
		<exec command="cp //'$LOGNAME$.J9CORE.DMP.X001' $DUMPFILE$.dmp" platforms="zos_390-64.*" />
		<exec command="cp //'$LOGNAME$.J9CORE.DMP' $DUMPFILE$.dmp" platforms="zos_390-31.*" />
		<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
		<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
		<command>ls</command>
		<output type="success" caseSensitive="no" regex="no">$DUMPFILE$.dmp</output>
	</test>
	
	<test id="Test 180-c: Verify that Intermediate Class Data is present for non-bootstrap class" timeout="600" runPath=".">
        <command command="$JDMPVIEW_EXE$">
                <arg>-core $DUMPFILE$.dmp</arg>
                <input>!dumpromclass name:$CLASS_HANOI$</input>
                <input>quit</input>
        </command>
		<output type="success" regex="yes" javaUtilPattern="yes" showMatch="yes">Intermediate Class Data \([^0][0-9]* bytes\): [^0][0-9a-fA-F]*</output>
		<output type="failure" regex="no">no shared cache</output>
		<output type="failure" regex="no">unable to read</output>
		<output type="failure" regex="no">could not read</output>
		<output type="failure" regex="no">dump event</output>
		<output type="failure" regex="no">DDRInteractiveCommandException</output>
	</test>
	
	<test id="Test 180-d: Verify that Intermediate Class Data is present for bootstrap class" timeout="600" runPath=".">
        <command command="$JDMPVIEW_EXE$">
                <arg>-core $DUMPFILE$.dmp</arg>
                <input>!dumpromclass name:$BOOTSTRAP_CLASS$</input>
                <input>quit</input>
        </command>
		<output type="success" regex="yes" javaUtilPattern="yes" showMatch="yes">Intermediate Class Data \([^0][0-9]* bytes\): [^0][0-9a-fA-F]*</output>
		<output type="failure" regex="no">no shared cache</output>
		<output type="failure" regex="no">unable to read</output>
		<output type="failure" regex="no">could not read</output>
		<output type="failure" regex="no">dump event</output>
		<output type="failure" regex="no">DDRInteractiveCommandException</output>
	</test>
	
	<exec command="rm -f $DUMPFILE$.dmp" quiet="false" />
	
	<!-- Remove stale dumps, if any. Test 180-e is going to create new dumps. -->
	<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
	<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
	
	<test id="Test 180-e: Create a system dump by using a shared cache with enableBCI option and without a JVMTI agent" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $SYSDUMP$,events=vmstop $currentMode$,reset,enableBCI $CP_HANOI$ $PROGRAM_HANOI$</command>
		<output type="success" regex="no">Moved disk 0 to 1</output>
		<output type="required" regex="no">System dump written</output>
		<!-- check for unexpected core dumps -->
		<output regex="no" type="failure">0001.dmp</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
	</test>
	
	<test id="Test 180-f: Make sure system dump exists." timeout="600" runPath=".">
		<exec command="sh" capture="LOGNAME" platforms="zos.*" >
			<arg>-c</arg>
			<arg>echo $$LOGNAME</arg>
		</exec>
		<exec command="cp //'$LOGNAME$.J9CORE.DMP.X001' $DUMPFILE$.dmp" platforms="zos_390-64.*" />
		<exec command="cp //'$LOGNAME$.J9CORE.DMP' $DUMPFILE$.dmp" platforms="zos_390-31.*" />
		<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
		<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
		<command>ls</command>
		<output type="success" caseSensitive="no" regex="no">$DUMPFILE$.dmp</output>
	</test>
	
	<test id="Test 180-g: Verify that Intermediate Class Data is present for non-bootstrap class" timeout="600" runPath=".">
        <command command="$JDMPVIEW_EXE$">
                <arg>-core $DUMPFILE$.dmp</arg>
                <input>!dumpromclass name:$CLASS_HANOI$</input>
                <input>quit</input>
        </command>
		<output type="success" regex="yes" javaUtilPattern="yes" showMatch="yes">Intermediate Class Data \([^0][0-9]* bytes\): [^0][0-9a-fA-F]*</output>
		<output type="failure" regex="no">no shared cache</output>
		<output type="failure" regex="no">unable to read</output>
		<output type="failure" regex="no">could not read</output>
		<output type="failure" regex="no">dump event</output>
		<output type="failure" regex="no">DDRInteractiveCommandException</output>
	</test>
	
	<test id="Test 180-h: Verify that Intermediate Class Data is present for bootstrap class" timeout="600" runPath=".">
        <command command="$JDMPVIEW_EXE$">
                <arg>-core $DUMPFILE$.dmp</arg>
                <input>!dumpromclass name:$BOOTSTRAP_CLASS$</input>
                <input>quit</input>
        </command>
		<output type="success" regex="yes" javaUtilPattern="yes" showMatch="yes">Intermediate Class Data \([^0][0-9]* bytes\): [^0][0-9a-fA-F]*</output>
		<output type="failure" regex="no">no shared cache</output>
		<output type="failure" regex="no">unable to read</output>
		<output type="failure" regex="no">could not read</output>
		<output type="failure" regex="no">dump event</output>
		<output type="failure" regex="no">DDRInteractiveCommandException</output>
	</test>
	
	<exec command="rm -f $DUMPFILE$.dmp" quiet="false" />
	
	<!-- 
		Note: Tests 181(a-d) validate following scenario:
		When running with -Xshareclasses:enableBCI, if for some reason, we fail to store ROMClass in the cache,
		and retransformation is enabled, then the ROMClass should contain intermediate class data.
	-->
	<test id="Test 181-a: Create a shared cache with enableBCI option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,enableBCI -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<!-- Remove stale dumps, if any. Test 181-b is going to create new dumps. -->
	<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
	<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
	
	<test id="Test 181-b: Create a system dump by using previously created cache in read only mode with a JVMTI agent that has retransformation enabled" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $SYSDUMP$,events=vmstop $currentMode$,enableBCI,readonly $AGENT_RETRANSFORM$ $CP_HANOI$ $PROGRAM_HANOI$</command>
		<output type="success" regex="no">Moved disk 0 to 1</output>
		<output type="required" regex="no">System dump written</output>
		<!-- check for unexpected core dumps -->
		<output regex="no" type="failure">0001.dmp</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
	</test>
	
	<test id="Test 181-c: Make sure system dump exists." timeout="600" runPath=".">
		<exec command="sh" capture="LOGNAME" platforms="zos.*" >
			<arg>-c</arg>
			<arg>echo $$LOGNAME</arg>
		</exec>
		<exec command="cp //'$LOGNAME$.J9CORE.DMP.X001' $DUMPFILE$.dmp" platforms="zos_390-64.*" />
		<exec command="cp //'$LOGNAME$.J9CORE.DMP' $DUMPFILE$.dmp" platforms="zos_390-31.*" />
		<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
		<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
		<command>ls</command>
		<output type="success" caseSensitive="no" regex="no">$DUMPFILE$.dmp</output>
	</test>
	
	<test id="Test 181-d: Verify that Intermediate Class Data is present" timeout="600" runPath=".">
        <command command="$JDMPVIEW_EXE$">
                <arg>-core $DUMPFILE$.dmp</arg>
                <input>!dumpromclass name:$CLASS_HANOI$</input>
                <input>quit</input>
        </command>
		<output type="success" regex="yes" javaUtilPattern="yes" showMatch="yes">Intermediate Class Data \([^0][0-9]* bytes\): [^0][0-9a-fA-F]*</output>
		<output type="failure" regex="no">no shared cache</output>
		<output type="failure" regex="no">unable to read</output>
		<output type="failure" regex="no">could not read</output>
		<output type="failure" regex="no">dump event</output>
		<output type="failure" regex="no">DDRInteractiveCommandException</output>
	</test>
	
	<exec command="rm -f $DUMPFILE$.dmp" quiet="false" />
	
	<!-- 
		Note: Tests 182(a-d) validate following scenario:
		When running with -Xshareclasses:enableBCI, if for some reason, we fail to store ROMClass in the cache,
		and retransformation is disabled, then the ROMClass should still contain intermediate class data.
	-->
	<test id="Test 182-a: Create a shared cache with enableBCI option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,enableBCI -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<!-- Remove stale dumps on z/OS, if any. Test 182-b is going to create new dumps. -->
	<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
	<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
	
	<test id="Test 182-b: Create a system dump using previously created cache in read only mode with a JVMTI agent that has retransformation disabled" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $SYSDUMP$,events=vmstop $currentMode$,enableBCI,readonly $AGENT_NOCLASSMODIFICATION$ $CP_HANOI$ $PROGRAM_HANOI$</command>
		<output type="success" regex="no">Moved disk 0 to 1</output>
		<output type="required" regex="no">System dump written</output>
		<!-- check for unexpected core dumps -->
		<output type="failure" regex="no">0001.dmp</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
	</test>
	
	<test id="Test 182-c: Make sure system dump exists." timeout="600" runPath=".">
		<exec command="sh" capture="LOGNAME" platforms="zos.*" >
			<arg>-c</arg>
			<arg>echo $$LOGNAME</arg>
		</exec>
		<exec command="cp //'$LOGNAME$.J9CORE.DMP.X001' $DUMPFILE$.dmp" platforms="zos_390-64.*" />
		<exec command="cp //'$LOGNAME$.J9CORE.DMP' $DUMPFILE$.dmp" platforms="zos_390-31.*" />
		<exec command="tso delete J9CORE.DMP.*" platforms="zos_390-64.*" />
		<exec command="tso delete J9CORE.DMP" platforms="zos_390-31.*" />
		<command>ls</command>
		<output type="success" caseSensitive="no" regex="no">$DUMPFILE$.dmp</output>
	</test>
	
	<test id="Test 182-d: Verify that Intermediate Class Data is present" timeout="600" runPath=".">
        <command command="$JDMPVIEW_EXE$">
                <arg>-core $DUMPFILE$.dmp</arg>
                <input>!dumpromclass name:$CLASS_HANOI$</input>
                <input>quit</input>
        </command>
		<output type="success" regex="yes" javaUtilPattern="yes" showMatch="yes">Intermediate Class Data \([^0][0-9]* bytes\): [^0][0-9a-fA-F]*</output>
		<output type="failure" regex="no">no shared cache</output>
		<output type="failure" regex="no">unable to read</output>
		<output type="failure" regex="no">could not read</output>
		<output type="failure" regex="no">dump event</output>
		<output type="failure" regex="no">DDRInteractiveCommandException</output>
	</test>
	
	<exec command="rm -f $DUMPFILE$.dmp" quiet="false" />
	
	<!-- Tests 183a-f Verify printStats and javacore output when enableBCI sub-option is used. -->
	
	<test id="Test 183-a: Create a cache and javacore without enableBCI option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ -Xdump:java:events=vmstop,file=javacore.txt $currentMode$,reset -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="required" caseSensitive="yes" regex="no">Processed dump event</output>
		<output type="required" caseSensitive="yes" regex="no">javacore.txt</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
	</test>
	
	<test id="Test 183-b: Ensure BCI Enabled is true" timeout="600" runPath=".">
		<command>cat javacore.txt</command>				
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes" showMatch="yes">BCI Enabled[\s]*= true</output>
		<output type="failure" caseSensitive="no" regex="yes" javaUtilPattern="yes" showMatch="yes">BCI Enabled[\s]*= false</output>
	</test>
	
	<test id="Test 183-c: Verify BCI Enabled is true in printStats output" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,printStats -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">BCI Enabled[\s]*= true</output>
		<output type="failure" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<exec command="rm -f javacore.txt" quiet="false"/>
	
	<test id="Test 183-d: Create a cache and javacore with enableBCI option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ -Xdump:java:events=vmstop,file=javacore.txt $currentMode$,reset,enableBCI -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="required" caseSensitive="yes" regex="no">Processed dump event</output>
		<output type="required" caseSensitive="yes" regex="no">javacore.txt</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
	</test>
	
	<test id="Test 183-e: Ensure BCI Enabled is true in generated javacore" timeout="600" runPath=".">
		<command>cat javacore.txt</command>				
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes" showMatch="yes">BCI Enabled[\s]*= true</output>
		<output type="failure" caseSensitive="no" regex="yes" javaUtilPattern="yes" showMatch="yes">BCI Enabled[\s]*= false</output>
	</test>
	
	<test id="Test 183-f: Ensure BCI Enabled is true in printStats output" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,printStats -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">BCI Enabled[\s]*= true</output>
		<output type="failure" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>

	<exec command="rm -f javacore.txt" quiet="false"/>
	
	<!-- Tests 184a-m verify that shared class utility options like printStats, destroy, destroyAll work even when incompatible options are present.
		 Right now enableBCI and cacheRetransformed are treated as incompatible options.
	-->
	<test id="Test 184-a: Create a cache without enableBCI sub-option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-b: Run 'printStats' on existing cache with incompatible options specified at the end in the option list" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,printStats,enableBCI,cacheRetransformed</command>
		<output type="success" caseSensitive="yes" regex="no">Current statistics for cache</output>
		<output type="required" caseSensitive="yes" regex="yes" javaUtilPattern="yes">BCI Enabled[\s]*= true</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-c: Run 'printStats' on existing cache with incompatible options specified before 'printStats' in the option list" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,enableBCI,cacheRetransformed,printStats</command>
		<output type="success" caseSensitive="yes" regex="no">Current statistics for cache</output>
		<output type="required" caseSensitive="yes" regex="yes" javaUtilPattern="yes">BCI Enabled[\s]*= true</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-d: Run 'listAllCaches' with incompatible options specified at the end in the option list" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,listAllCaches,enableBCI,cacheRetransformed</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes" showMatch="yes">Cache[\s]*name[\s]*level[\s]*(persistent|cache-type)(.)*last detach time</output>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes" showMatch="yes">ShareClassesCMLTests[\s]*Java(.)*(yes|persistent)</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-e: Run 'listAllCaches' with incompatible options specified before 'listAllCaches' in the option list" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,enableBCI,cacheRetransformed,listAllCaches</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes" showMatch="yes">Cache[\s]*name[\s]*level[\s]*(persistent|cache-type)(.)*last detach time</output>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes" showMatch="yes">ShareClassesCMLTests[\s]*Java(.)*(yes|persistent)</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-f: Run 'destroy' on existing cache with incompatible options specified at the end in the option list" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,destroy,enableBCI,cacheRetransformed</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
		
	<test id="Test 184-g: Create a cache without enableBCI sub-option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-h: Run 'destroy' on existing cache with incompatible options specified before 'destroy' in the option list" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,enableBCI,cacheRetransformed,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-i: Create a cache without enableBCI sub-option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-j: Verify that using reset with incompatible options fails" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,enableBCI,cacheRetransformed -version</command>
		<output type="success" caseSensitive="yes" regex="no">JVMSHRC595E Command-line options "enableBCI" and "cacheRetransformed" are incompatible</output>
		<output type="required" caseSensitive="yes" regex="no">JVMJ9VM015W Initialization error</output>
		
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-k: Ensure previous test did not destroy the cache" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,printStats</command>
		<output type="success" caseSensitive="yes" regex="no">Current statistics for cache</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-l: Create a cache with enableBCI option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,enableBCI -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 184-m: Try to reset a BCI enabled cache with cacheRetransformed option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,cacheRetransformed -version</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		<output type="required" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<!-- Tests 185a-f checks that "cacheRetransformed" is incompatible with "enableBCI" sub-option -->
	
	<test id="Test 185-a: Destroy any existing cache" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,destroy -version</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 185-b: Verify that cacheRetransformed is incompatible with enableBCI sub-option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,enableBCI,cacheRetransformed -version</command>
		<output type="success" caseSensitive="yes" regex="no">JVMSHRC595E Command-line options "enableBCI" and "cacheRetransformed" are incompatible</output>
		<output type="required" caseSensitive="yes" regex="no">JVMJ9VM015W Initialization error</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 185-c: Verify that using cacheRetransformed and enableBCI with non-fatal sub-option does not fail" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,enableBCI,cacheRetransformed,nonfatal -version</command>
		<output type="success" caseSensitive="yes" regex="no">JVMSHRC595E Command-line options "enableBCI" and "cacheRetransformed" are incompatible</output>
		<output type="required" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 185-d: Create a cache with enableBCI option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,enableBCI -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 185-e: Verify that using cacheRetransformed sub-option is incompatible with BCI enabled cache" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheRetransformed -version</command>
		<output type="success" caseSensitive="yes" regex="no">JVMSHRC637E The -Xshareclasses:cacheRetransformed sub-option is incompatible with an existing BCI enabled shared cache.</output>
		<output type="required" caseSensitive="yes" regex="no">JVMJ9VM015W Initialization error</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 185-f: Verify that using cacheRetransformed and nonfatal sub-options with a BCI enabled cache does not fail" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheRetransformed,nonfatal -version</command>
		<output type="success" caseSensitive="yes" regex="no">JVMSHRC637E The -Xshareclasses:cacheRetransformed sub-option is incompatible with an existing BCI enabled shared cache.</output>
		<output type="required" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<exec command="rm -fr $CACHE_DIR_FOR_PERM_TEST$" quiet="false" platforms="$NON_WINDOWS_PLATFORMS$" />
	
	<test id="Test 186-a: Test for valid value of 'cacheDirPerm' sub-option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,cacheDir=$CACHE_DIR_FOR_PERM_TEST$,cacheDirPerm=0744 -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 186-b: Verify that cache can be re-used" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheDir=$CACHE_DIR_FOR_PERM_TEST$ -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 186-c: Cleanup the cache" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheDir=$CACHE_DIR_FOR_PERM_TEST$,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		
		<output type="failure" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="failure" caseSensitive="no"  regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<exec command="rm -fr $CACHE_DIR_FOR_PERM_TEST$" quiet="false" platforms="$NON_WINDOWS_PLATFORMS$"/>
	
	<test id="Test 187-a: Test for valid value of 'cacheDirPerm' sub-option with sticky bit on" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,cacheDir=$CACHE_DIR_FOR_PERM_TEST$,cacheDirPerm=1744 -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 187-b: Verify that cache can be re-used" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheDir=$CACHE_DIR_FOR_PERM_TEST$ -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 187-c: Cleanup the cache" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheDir=$CACHE_DIR_FOR_PERM_TEST$,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		
		<output type="failure" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="failure" caseSensitive="no"  regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<exec command="rm -fr $CACHE_DIR_FOR_PERM_TEST$" quiet="false" platforms="$NON_WINDOWS_PLATFORMS$"/>
	
	<test id="Test 188-a: Test for special value of 'cacheDirPerm' sub-option" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,reset,cacheDir=$CACHE_DIR_FOR_PERM_TEST$,cacheDirPerm=0000 -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 188-b: Verify that cache can be re-used" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheDir=$CACHE_DIR_FOR_PERM_TEST$ -version</command>
		<output type="success" caseSensitive="yes" regex="yes" javaUtilPattern="yes">(java|openjdk) version</output>
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<test id="Test 188-c: Cleanup the cache" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,cacheDir=$CACHE_DIR_FOR_PERM_TEST$,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		
		<output type="failure" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="failure" caseSensitive="no"  regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
	</test>
	
	<exec command="rm -fr $CACHE_DIR_FOR_PERM_TEST$" quiet="false" platforms="$NON_WINDOWS_PLATFORMS$" />

	<test id="Verify whether VM successfully runs in read-only shared cache with testBadBuildID and nonfatal option specified" timeout="600" runPath=".">
		<command>$JAVA_EXE$ -Xint -Xshareclasses:testBadBuildID,verbose,readonly,nonfatal -version</command>
		<output type="required" caseSensitive="yes" regex="no">Continue without using it as -Xshareclasses:nonfatal is specified</output>
		<output type="success"  caseSensitive="yes" regex="yes" javaUtilPattern="yes">(OpenJDK|Java\(TM\) SE) Runtime Environment</output>
		
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
		<output type="failure" caseSensitive="yes" regex="no">JVM requested Java dump</output>
		<output type="failure" caseSensitive="yes" regex="no">JVM requested Snap dump</output>
	</test>
	
	<test id="At end destroy cache for cleanup" timeout="600" runPath=".">
		<command>$JAVA_EXE$ $currentMode$,destroy</command>
		<output type="success" caseSensitive="yes" regex="no">Cache does not exist</output>
		<output type="success" caseSensitive="yes" regex="no">has been destroyed</output>
		<output type="success" caseSensitive="yes" regex="no">is destroyed</output>
		
		<output type="failure" caseSensitive="no" regex="no">Unhandled Exception</output>
		<output type="failure" caseSensitive="yes" regex="no">Exception:</output>
		<output type="failure" caseSensitive="no" regex="no">corrupt</output>
		<output type="failure" caseSensitive="yes" regex="no">Processing dump event</output>
		<output type="failure" caseSensitive="yes" regex="no">JVM requested Java dump</output>
		<output type="failure" caseSensitive="yes" regex="no">JVM requested Snap dump</output>
	</test>
		
	<!--
	***** IMPORTANT NOTE *****
	The last test in this file is normally a call to -Xshareclasses:destroy. When the test passes no files should ever be left behind. 
	-->
</suite>

